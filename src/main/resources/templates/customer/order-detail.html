<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Inter', sans-serif;
    }

    .order-detail-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 15px;
    }

    .order-detail-card {
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 2rem;
    }

    .order-summary {
      background-color: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .order-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.3s ease;
    }

    .order-item:hover {
      background-color: #f8f9fa;
    }

    .product-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 12px;
      margin-right: 1.5rem;
    }

    .product-details {
      flex-grow: 1;
    }

    .product-details h6 {
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .quantity-control button {
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .price-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
    }

    .save-button {
      display: none;
    }

    .actions-container {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .payment-section {
      display: flex;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }
  </style>
</head>

<body>
  <div th:replace="~{customer/common/header}"></div>

  <div class="order-detail-container">
    <div class="order-detail-card">
      <h2 class="text-center mb-4">Order #<span th:text="${orderDTO.id}"></span> Details</h2>

      <!-- Order Summary Section -->
      <div class="order-summary">
        <div class="row g-3">
          <div class="col-md-4">
            <strong>Order Created</strong>
            <p class="text-muted" th:text="${orderDTO.createdDate}"></p>
          </div>
          <div class="col-md-4">
            <strong>Shipping Address</strong>
            <p class="text-muted" th:text="${orderDTO.address}"></p>
          </div>
          <div class="col-md-4">
            <strong>Total Price</strong>
            <p class="text-muted" id="order-total-price" th:text="${orderDTO.totalPrice}"></p>
          </div>
          <div class="col-md-4">
            <strong>Payment Status</strong>
            <p th:classappend="${orderDTO.paymentStatus.name == 'PAID' ? ' text-success font-weight-bold' : ''}"
               th:text="${orderDTO.paymentStatus}">
            </p>
          </div>
          <div class="col-md-4">
            <strong>Order Status</strong>
            <p class="text-muted" th:text="${orderDTO.statusType}"></p>
          </div>
        </div>
      </div>

      <!-- Order Items Section -->
      <h4 class="mt-4 mb-3">Order Items</h4>
      <div th:each="item : ${orderDTO.orderItemList}">
        <div class="order-item" th:id="'item-' + ${item.id}">
          <img th:src="'data:image/jpeg;base64,' + ${item.images[0]}" th:alt="${item.name}" class="product-image">

          <div class="product-details">
            <h6 th:text="${item.name}"></h6>
            <div class="text-muted">
              <span>Size: <span th:text="${item.size.size}"></span></span>
              <span th:text="'Price: ' + ${item.price} + 'VNĐ'"></span>
            </div>
          </div>

          <div class="price-section">
            <div class="actions-container">
              <div class="quantity-control">
                <button
                        th:style="${orderDTO.paymentStatus.name() == 'PAID' ? 'display:none;' : ''}"
                        th:onclick="'decreaseQuantity(' + ${item.id} + ')'" class="btn btn-outline-secondary"
                  th:disabled="${item.quantity == 1}">
                  <i class="bi bi-dash"></i>
                </button>
                <span th:id="'quantity-display-' + ${item.id}" th:text="${item.quantity}"
                  th:attr="data-base-price=${item.price}" class="quantity-display"></span>
                <button
                        th:style="${orderDTO.paymentStatus.name() == 'PAID' ? 'display:none;' : ''}"
                        th:onclick="'increaseQuantity(' + ${item.id} + ')'" class="btn btn-outline-secondary">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
              <button class="btn btn-danger btn-sm"
                      th:style="${orderDTO.paymentStatus.name() == 'PAID' ? 'display:none;' : ''}"
                      th:onclick="'deleteItem(' + ${item.id} + ')'" title="Remove item">
                <i class="bi bi-trash"></i>
              </button>
              <button
                      th:style="${orderDTO.paymentStatus.name() == 'PAID' ? 'display:none;' : ''}"
                      th:id="'save-btn-' + ${item.id}" class="btn btn-primary btn-sm save-button"
                th:onclick="'saveQuantityChanges(' + ${item.id} + ')'">
                Save
              </button>
            </div>
            <strong th:id="'total-price-' + ${item.id}" th:text="'Subtotal: ' + ${item.totalPrice} + 'VNĐ'"></strong>
          </div>
        </div>
      </div>

      <!-- Payment Section -->
      <div class="payment-section">
        <button id="pay-button"
                class="btn btn-success btn-lg"
                th:disabled="${orderDTO.paymentStatus.name() == 'PAID'}"
                th:onclick="'createPayment(' + ${orderDTO.id} + ')'">
          <i class="bi bi-credit-card"></i> Thanh Toán
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function createPayment(orderId) {
  if (confirm('Bạn có chắc muốn thanh toán đơn hàng này không?')) {
    try {
      // Gửi request tới server
      const response = await fetch(`/v1/api/customer/order/${orderId}/payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      // Kiểm tra mã trạng thái HTTP
      if (!response.ok) {
        throw new Error(`Lỗi HTTP: ${response.status}`);
      }

      const data = await response.json();

      if (data.success) {
        alert('Thanh toán đang được xử lý...');
        // Chuyển hướng người dùng đến URL VNPay
        window.location.href = data.vnpayUrl;
      } else {
        alert('Thanh toán thất bại: ' + data.message); // Thông báo lỗi khi thanh toán thất bại
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Đã xảy ra lỗi. Vui lòng thử lại.'); // Xử lý lỗi khi có sự cố mạng hoặc lỗi khác
    }
  }
}



    function updateTotalPrice() {

      const quantityDisplays = document.getElementsByClassName('quantity-display');
      const orderTotalPrice = document.getElementById('order-total-price');

      const totalSum = Array.from(quantityDisplays)
        .map(display => parseFloat(display.dataset.basePrice) * parseInt(display.textContent) || 0)
        .reduce((sum, basePrice) => sum + basePrice, 0).toFixed(2);
      orderTotalPrice.textContent = totalSum + ' VNĐ';
      console.log(totalSum);

    }

    function updateItemDisplay(itemId, quantity) {
      const quantityDisplay = document.getElementById('quantity-display-' + itemId);
      const priceDisplay = document.getElementById('total-price-' + itemId);
      const saveButton = document.getElementById('save-btn-' + itemId);
      const basePrice = parseFloat(quantityDisplay.dataset.basePrice);

      quantityDisplay.textContent = quantity;
      const totalPrice = (basePrice * quantity).toFixed(2);
      priceDisplay.textContent = 'Subtotal: $' + totalPrice;
      updateTotalPrice();
      saveButton.style.display = 'inline-block';
    }

    function increaseQuantity(itemId) {
      const quantitySpan = document.getElementById('quantity-display-' + itemId);
      let quantity = parseInt(quantitySpan.textContent) + 1;
      updateItemDisplay(itemId, quantity);
    }

    function decreaseQuantity(itemId) {
      const quantitySpan = document.getElementById('quantity-display-' + itemId);
      let quantity = parseInt(quantitySpan.textContent);

      if (quantity > 1) {
        quantity -= 1;
        updateItemDisplay(itemId, quantity);
      }
    }

    function saveQuantityChanges(itemId) {
      const quantitySpan = document.getElementById('quantity-display-' + itemId);
      const quantity = parseInt(quantitySpan.textContent);

      fetch(`/order/updateItemQuantity/${itemId}/save?quantity=${quantity}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const saveButton = document.getElementById('save-btn-' + itemId);
            saveButton.style.display = 'none';
          } else {
            alert('Failed to update quantity. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
        });
    }

    function deleteItem(itemId) {
      if (confirm('Are you sure you want to remove this item from the order?')) {
        fetch(`/order/deleteItem/${itemId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const itemElement = document.getElementById('item-' + itemId);
              itemElement.remove();
            } else {
              alert('Failed to delete item. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          });
      }
    }
  </script>
</body>

</html>